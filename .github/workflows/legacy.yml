name: Legacy PHP 5.6 Build

on:
  pull_request:
  workflow_dispatch:

env:
  TZ: "/usr/share/zoneinfo/America/Los_Angeles"
  TERM: dumb
  PHPUNIT_ARGS: ""
  PHP_SENDMAIL_PATH: /dev/null
  DOCKERIZE_VERSION: v0.6.1
  COMPOSER_ALLOW_SUPERUSER: "1"
  COMPOSER_MEMORY_LIMIT: -1
  COMPOSER_DISABLE_XDEBUG_WARN: "1"

jobs:
  legacy-test:
    name: php 5.6 / drupal 8.6 (Legacy)
    runs-on: ubuntu-latest

    container:
      image: wodby/php:5.6
      options: --user root

    services:
      mariadb:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testsiteaudittooldatabase
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s --health-timeout=5s --health-retries=30

    steps:
      - name: Manual Checkout (Legacy PHP 5.6)
        run: |
          git init
          git remote add origin https://github.com/${{ github.repository }}
          git fetch --no-tags --prune --progress --depth=1 origin ${{ github.sha }}
          git checkout --progress --force ${{ github.sha }}

      - name: Mark workspace as safe for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install required tools (Alpine)
        run: |
          apk add --no-cache git unzip bash mariadb-client wget coreutils jq ca-certificates

      - name: Install Composer v1 (explicit)
        run: |
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          php composer-setup.php --1 --install-dir=/usr/local/bin --filename=composer
          php -r "unlink('composer-setup.php');"
          composer --version
          # Ensure packagist is configured explicitly
          composer config -g repos.packagist composer https://repo.packagist.org

      - name: Copy PHP ini
        run: cp .github/workflows/zz-php.ini /usr/local/etc/php/conf.d/

      - name: Prepare Legacy Composer Environment (strip packages.drupal.org)
        run: |
          # Start from the legacy scenario definition
          rm -f composer.lock
          cp .scenarios.lock/php56/composer.json composer.json

          # If the legacy composer.json contains the Drupal.org repo, remove it for Composer 1 compatibility
          # This deletes any repository whose URL matches packages.drupal.org
          if jq -e '.repositories' composer.json >/dev/null 2>&1; then
            jq 'if .repositories then
                  .repositories |= (map(select((.url? // "") | test("packages\\.drupal\\.org") | not)))
                else . end' composer.json > composer.cleaned.json
            mv composer.cleaned.json composer.json
          fi

          # Sanity: show which repos remain
          jq '.repositories // []' composer.json || true

      - name: Add Legacy Dev Requirements (PHPUnit 5 + Drush 8)
        run: |
          composer config platform.php 5.6
          # Add dev requirements without triggering an install yet
          composer require --dev phpunit/phpunit:"^5.0" drush/drush:"^8.4" --no-update

      - name: Install Legacy Dependencies
        run: |
          # Ignore platform reqs to let Composer resolve on a PHP 5.6 target while Composer 1 runs fine
          composer update --prefer-dist --no-interaction --ignore-platform-reqs
          composer dump-autoload -o
          test -f vendor/autoload.php || (echo "vendor/autoload.php missing!" && exit 1)

      - name: Lint tests and check class
        run: |
          php -l tests/src/Fixtures.php
          ls -l vendor/autoload.php
          php -r "require 'vendor/autoload.php'; var_dump(class_exists('SiteAudit\\Fixtures'));"

      - name: Manual Drupal Scaffold (8.6.18)
        run: |
          set -ex
          mkdir -p sut/web/sites/default
          DRUPAL_VERSION="8.6.18"
          SCAFFOLD_URL="https://raw.githubusercontent.com/drupal/drupal/${DRUPAL_VERSION}"
          WEB_ROOT="sut/web"
          wget -q -O "${WEB_ROOT}/.htaccess" "${SCAFFOLD_URL}/.htaccess"
          wget -q -O "${WEB_ROOT}/index.php" "${SCAFFOLD_URL}/index.php"
          wget -q -O "${WEB_ROOT}/robots.txt" "${SCAFFOLD_URL}/robots.txt"
          wget -q -O "${WEB_ROOT}/update.php" "${SCAFFOLD_URL}/update.php"
          wget -q -O "${WEB_ROOT}/sites/default/default.settings.php" "${SCAFFOLD_URL}/sites/default/default.settings.php"

      - name: Install dockerize (for DB wait)
        run: |
          wget -q https://github.com/jwilder/dockerize/releases/download/${DOCKERIZE_VERSION}/dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz
          tar -C "$HOME" -xzf dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz
          rm dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz

      - name: Wait for MariaDB
        run: $HOME/dockerize -wait tcp://mariadb:3306 -timeout 60s

      - name: Set runtime env (correct paths & DSN)
        run: |
          echo "DRUSH_OPTIONS_ROOT=$GITHUB_WORKSPACE/sut/web" >> "$GITHUB_ENV"
          echo "DRUSH_OPTIONS_URI=http://default" >> "$GITHUB_ENV"
          echo "UNISH_DB_URL=mysql://root:root@mariadb:3306/testsiteaudittooldatabase" >> "$GITHUB_ENV"

      - name: Make mysql CLI avoid TLS, and precreate DB
        run: |
          cat > "$HOME/.my.cnf" <<'EOF'
          [client]
          host=mariadb
          user=root
          password=root
          protocol=tcp
          skip-ssl
          EOF
          chmod 600 "$HOME/.my.cnf"
          mysql -e 'DROP DATABASE IF EXISTS testsiteaudittooldatabase;'
          mysql -e 'CREATE DATABASE testsiteaudittooldatabase CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;'
          mysql -e 'SHOW DATABASES;'

      - name: DB prep / disable SSL
        run: |
          export MYSQL_SSL_MODE=DISABLED
          mysql -hmariadb -P3306 -uroot -proot -e \
            "DROP DATABASE IF EXISTS testsiteaudittooldatabase;
             CREATE DATABASE testsiteaudittooldatabase
             CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;"

      - name: Provision SUT (single path)
        env:
          DRUSH_OPTIONS_ROOT: ${{ github.workspace }}/sut/web
          DRUSH_OPTIONS_URI: http://default
          UNISH_DB_URL: mysql://root:root@mariadb:3306/testsiteaudittooldatabase
          DRUSH_OPTIONS_YES: "1"
          DRUSH_OPTIONS_NO_INTERACTION: "1"
          MYSQL_SSL_MODE: DISABLED
        run: |
          set -eux
          SITES_DIR="${DRUSH_OPTIONS_ROOT}/sites/default"
          [ -f "$SITES_DIR/settings.php" ] || { cp "$SITES_DIR"/default.settings.php "$SITES_DIR"/settings.php && chmod 644 "$SITES_DIR"/settings.php; }
          timeout 15m bash -ce '
            php -d xdebug.mode=off -r "require \"vendor/autoload.php\"; SiteAudit\\Fixtures::createSut(); echo \"SUT ready\n\";"
          '
          vendor/bin/drush status --yes --no-interaction --fields=bootstrap,db-status,db-driver,db-hostname,db-name

      - name: Check SUT path
        run: |
          echo "Expecting: $GITHUB_WORKSPACE/sut/web"
          test -d "$GITHUB_WORKSPACE/sut/web" || (echo "SUT missing; did the scenario install run?" && exit 1)

      - name: Clean up test environment
        run: |
          rm -f sut/web/test.php
          mkdir -p sut/web/modules/contrib/php

      - name: Run tests
        env:
          DRUSH_OPTIONS_ROOT: ${{ github.workspace }}/sut/web
          DRUSH_OPTIONS_URI: http://default
          UNISH_DB_URL: mysql://root:root@mariadb:3306/testsiteaudittooldatabase
        run: |
          vendor/bin/phpunit --colors=always ${PHPUNIT_ARGS}