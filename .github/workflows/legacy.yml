name: Legacy PHP 5.6 Build (No-Composer)

on:
  pull_request:
  workflow_dispatch:

env:
  TZ: "/usr/share/zoneinfo/America/Los_Angeles"
  TERM: dumb
  PHPUNIT_ARGS: ""
  PHP_SENDMAIL_PATH: /dev/null
  DOCKERIZE_VERSION: v0.6.1

jobs:
  legacy-test:
    name: php 5.6 / drupal 8.6 (Legacy, Composer-free)
    runs-on: ubuntu-latest

    container:
      image: wodby/php:5.6
      options: --user root

    services:
      mariadb:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testsiteaudittooldatabase
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s --health-timeout=5s --health-retries=30

    steps:
      - name: Manual Checkout (Legacy PHP 5.6)
        run: |
          git init
          git remote add origin https://github.com/${{ github.repository }}
          git fetch --no-tags --prune --progress --depth=1 origin ${{ github.sha }}
          git checkout --progress --force ${{ github.sha }}

      - name: Mark workspace as safe for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install required tools (Alpine)
        run: |
          apk add --no-cache bash wget curl git unzip ca-certificates mariadb-client coreutils tar

      - name: Copy PHP ini (optional)
        run: cp .github/workflows/zz-php.ini /usr/local/etc/php/conf.d/ || true

      # -------------------------------
      # Composer-free tooling
      # -------------------------------
      - name: Fetch PHPUnit 5 PHAR
        run: |
          mkdir -p tools
          wget -q -O tools/phpunit.phar https://phar.phpunit.de/phpunit-5.7.27.phar
          chmod +x tools/phpunit.phar
          php tools/phpunit.phar --version

      - name: Fetch Drush 8 PHAR (PHP 5.6–safe)
        run: |
          set -euo pipefail
          mkdir -p tools
          for V in 8.4.9 8.4.1; do
            url="https://github.com/drush-ops/drush/releases/download/${V}/drush.phar"
            echo "Trying ${url}"
            if wget -q -O tools/drush.phar "$url"; then
              chmod +x tools/drush.phar
              if php tools/drush.phar --version >/dev/null 2>&1; then
                echo "Using Drush ${V}"
                php tools/drush.phar --version
                exit 0
              fi
            fi
          done
          echo "Failed to fetch a PHP 5.6–compatible drush.phar" >&2
          exit 1

      - name: Create drush wrapper at vendor/bin/drush
        run: |
          mkdir -p vendor/bin
          cat > vendor/bin/drush <<'SH'
          #!/bin/sh
          REPO_ROOT="$(CDPATH= cd -- "$(dirname -- "$0")/../.." && pwd)"
          exec php "$REPO_ROOT/tools/drush.phar" "$@"
          SH
          chmod +x vendor/bin/drush

      - name: Provide Drush TestTraits shim (PHP 5.6)
        run: |
          mkdir -p vendor/Drush/TestTraits
          cat > vendor/Drush/TestTraits/DrushTestTrait.php <<'PHP'
          <?php
          namespace Drush\TestTraits;
          trait DrushTestTrait {
            protected function drush($command, array $args = [], array $options = [], $expectedExit = 0) {
              $root = dirname(__DIR__, 2);
              $repo = dirname($root);
              $drush = $repo . '/vendor/bin/drush';
              if (is_executable($drush)) {
                $cmd = escapeshellarg($drush).' '.escapeshellarg($command);
                foreach ($args as $a) { $cmd .= ' '.escapeshellarg($a); }
                foreach ($options as $k => $v) {
                  $flag = '--'.preg_replace('/^--?/', '', (string)$k);
                  $cmd .= is_bool($v) ? " $flag" : " $flag=".escapeshellarg((string)$v);
                }
                system($cmd, $exit);
                return $exit === (int)$expectedExit;
              }
              return true;
            }
            protected function drushBatchProcess() { return true; }
          }
          PHP

      - name: Provide Symfony Filesystem shim (PHP 5.6)
        run: |
          mkdir -p vendor/Symfony/Component/Filesystem
          cat > vendor/Symfony/Component/Filesystem/Filesystem.php <<'PHP'
          <?php
          namespace Symfony\Component\Filesystem;
          class Filesystem {
            public function exists($files){foreach((array)$files as $f){if(!file_exists($f))return false;}return true;}
            public function mkdir($dirs,$mode=0777){foreach((array)$dirs as $d){if(!is_dir($d)&&!@mkdir($d,$mode,true)&&!is_dir($d))throw new \RuntimeException("Unable to create directory: $d");}}
            public function dumpFile($filename,$content){$dir=dirname($filename);if(!is_dir($dir))$this->mkdir($dir);if(file_put_contents($filename,$content)===false)throw new \RuntimeException("Unable to write file: $filename");}
            public function copy($origin,$target,$overwriteNewer=false){if(!$overwriteNewer&&file_exists($target)&&filemtime($target)>=@filemtime($origin))return;$dir=dirname($target);if(!is_dir($dir))$this->mkdir($dir);if(!@copy($origin,$target))throw new \RuntimeException("Unable to copy $origin to $target");}
            public function remove($files){foreach((array)$files as $f){if(is_dir($f)&&!is_link($f)){$this->remove(glob(rtrim($f,'/').'/*',GLOB_NOSORT)?:[]);@rmdir($f);}elseif(file_exists($f)||is_link($f)){@unlink($f);}}}
          }
          PHP

      - name: Create minimal PSR-4 autoloader (no Composer)
        run: |
          mkdir -p vendor
          cat > vendor/autoload.php <<'PHP'
          <?php
          spl_autoload_register(function ($class) {
              $prefixes = [
                  'SiteAudit\\'                      => [__DIR__ . '/../src/', __DIR__ . '/../tests/src/'],
                  'Drush\\TestTraits\\'             => [__DIR__ . '/Drush/TestTraits/'],
                  'Symfony\\Component\\Filesystem\\' => [__DIR__ . '/Symfony/Component/Filesystem/'],
              ];
              foreach ($prefixes as $prefix => $baseDirs) {
                  $len = strlen($prefix);
                  if (strncmp($prefix, $class, $len) !== 0) continue;
                  $relative = str_replace('\\', '/', substr($class, $len)) . '.php';
                  foreach ($baseDirs as $baseDir) {
                      $file = $baseDir . $relative;
                      if (is_file($file)) { require $file; return true; }
                  }
              }
              return false;
          });
          PHP
          php -r "require 'vendor/autoload.php'; echo 'Autoloader OK'.PHP_EOL;"

      - name: Lint tests and check class
        run: |
          php -l tests/src/Fixtures.php
          ls -l vendor/autoload.php
          php -r "require 'vendor/autoload.php'; var_dump(class_exists('SiteAudit\\Fixtures'));"

      # -------------------------------
      # Install a REAL Drupal root (8.6.18 tarball)
      # -------------------------------
      - name: Install Drupal 8.6.18 to sut/web
        run: |
          set -eux
          mkdir -p sut
          cd sut
          wget -q -O drupal.tar.gz https://ftp.drupal.org/files/projects/drupal-8.6.18.tar.gz
          tar -xzf drupal.tar.gz
          rm drupal.tar.gz
          mv drupal-8.6.18 web
          # basic directories expected by many setups
          mkdir -p web/sites/default/files
          chmod -R 777 web/sites/default/files

      - name: Install dockerize (for DB wait)
        run: |
          wget -q "https://github.com/jwilder/dockerize/releases/download/${DOCKERIZE_VERSION}/dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz"
          tar -C "$HOME" -xzf "dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz"
          rm "dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz"

      - name: Wait for MariaDB
        run: $HOME/dockerize -wait tcp://mariadb:3306 -timeout 60s

      - name: Set runtime env (correct paths & DSN)
        run: |
          echo "DRUSH_OPTIONS_ROOT=$GITHUB_WORKSPACE/sut/web" >> "$GITHUB_ENV"
          echo "DRUSH_OPTIONS_URI=http://default" >> "$GITHUB_ENV"
          echo "UNISH_DB_URL=mysql://root:root@mariadb:3306/testsiteaudittooldatabase" >> "$GITHUB_ENV"

      - name: Make mysql CLI avoid TLS, and precreate DB
        run: |
          cat > "$HOME/.my.cnf" <<'EOF'
          [client]
          host=mariadb
          user=root
          password=root
          protocol=tcp
          skip-ssl
          EOF
          chmod 600 "$HOME/.my.cnf"
          mysql -e 'DROP DATABASE IF EXISTS testsiteaudittooldatabase;'
          mysql -e 'CREATE DATABASE testsiteaudittooldatabase CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;'
          mysql -e 'SHOW DATABASES;'

      - name: DB prep / disable SSL
        run: |
          export MYSQL_SSL_MODE=DISABLED
          mysql -hmariadb -P3306 -uroot -proot -e \
            "DROP DATABASE IF EXISTS testsiteaudittooldatabase;
             CREATE DATABASE testsiteaudittooldatabase
             CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;"

      - name: Provision SUT (single path)
        env:
          DRUSH_OPTIONS_ROOT: ${{ github.workspace }}/sut/web
          DRUSH_OPTIONS_URI: http://default
          UNISH_DB_URL: mysql://root:root@mariadb:3306/testsiteaudittooldatabase
          DRUSH_OPTIONS_YES: "1"
          DRUSH_OPTIONS_NO_INTERACTION: "1"
          MYSQL_SSL_MODE: DISABLED
        run: |
          set -eux
          SITES_DIR="${DRUSH_OPTIONS_ROOT}/sites/default"
          [ -f "$SITES_DIR/settings.php" ] || { cp "$SITES_DIR"/default.settings.php "$SITES_DIR"/settings.php && chmod 644 "$SITES_DIR"/settings.php; }

          # Use reflection to bypass the private constructor in SiteAudit\Fixtures.
          cat > /tmp/provision.php <<'PHP'
          <?php
          require 'vendor/autoload.php';
          $ref = new \ReflectionClass('\SiteAudit\Fixtures');
          $obj = $ref->newInstanceWithoutConstructor();
          if ($ctor = $ref->getConstructor()) {
              $ctor->setAccessible(true);
              $ctor->invoke($obj);
          }
          $obj->createSut();
          echo "SUT ready\n";
          PHP

          php -d xdebug.mode=off /tmp/provision.php

          # Drush via wrapper (points to tools/drush.phar)
          vendor/bin/drush \
            --root="$DRUSH_OPTIONS_ROOT" \
            --uri="$DRUSH_OPTIONS_URI" \
            status --yes --no-interaction \
            --fields=bootstrap,db-status,db-driver,db-hostname,db-name

      - name: Check SUT path
        run: |
          echo "Expecting: $GITHUB_WORKSPACE/sut/web"
          test -d "$GITHUB_WORKSPACE/sut/web" || (echo "SUT missing; did the scenario install run?" && exit 1)

      - name: Clean up test environment
        run: |
          rm -f sut/web/test.php || true
          mkdir -p sut/web/modules/contrib/php

      - name: Run tests (PHPUnit 5 PHAR)
        env:
          DRUSH_OPTIONS_ROOT: ${{ github.workspace }}/sut/web
          DRUSH_OPTIONS_URI: http://default
          UNISH_DB_URL: mysql://root:root@mariadb:3306/testsiteaudittooldatabase
        run: |
          php tools/phpunit.phar --bootstrap vendor/autoload.php --colors=always ${PHPUNIT_ARGS}
