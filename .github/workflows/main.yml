name: Site Audit Tool - Tests

on:
  pull_request:
  workflow_dispatch:

env:
  TZ: "/usr/share/zoneinfo/America/Los_Angeles"
  TERM: dumb
  PHPUNIT_ARGS: ""
  PHP_SENDMAIL_PATH: /dev/null
  DOCKERIZE_VERSION: v0.6.1

jobs:
  tests:
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest

    container:
      image: ${{ matrix.php_image }}
      options: --user root

    services:
      mariadb:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testsiteaudittooldatabase
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s --health-timeout=5s --health-retries=30

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: php 8.1 / drupal9
            php_image: wodby/php:8.1
            install_cmd: ".scenarios.lock/install drupal9"
            scaffold: "no"
          - name: php 8.0 / drupal9
            php_image: wodby/php:8.0
            install_cmd: ".scenarios.lock/install drupal9"
            scaffold: "no"
          - name: php 7.3 / drupal9 lowest
            php_image: wodby/php:7.3
            install_cmd: ".scenarios.lock/install drupal9 lowest"
            scaffold: "no"
          - name: php 7.3 / drupal8
            php_image: wodby/php:7.3
            install_cmd: ""
            scaffold: "no"
          - name: php 7.2 / drush8
            php_image: wodby/php:7.2
            install_cmd: ".scenarios.lock/install drush8"
            scaffold: "no"
          - name: php 5.6 / drupal 8.7
            php_image: wodby/php:5.6
            install_cmd: ".scenarios.lock/install php56"
            scaffold: "yes"

    steps:
      - name: Checkout (Modern PHP)
        if: matrix.php_image != 'wodby/php:5.6'
        uses: actions/checkout@v4

      - name: Manual Checkout (Legacy PHP 5.6)
        if: matrix.php_image == 'wodby/php:5.6'
        run: |
          git init
          git remote add origin https://github.com/${{ github.repository }}
          git fetch --no-tags --prune --progress --depth=1 origin ${{ github.sha }}
          git checkout --progress --force ${{ github.sha }}

      - name: Mark workspace as safe for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Update Composer to v2 for Legacy PHP
        if: matrix.php_image == 'wodby/php:7.2' || matrix.php_image == 'wodby/php:5.6'
        run: |
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          php composer-setup.php --install-dir=/usr/local/bin --filename=composer
          php -r "unlink('composer-setup.php');"
          composer --version

      - name: Force Composer to use dist everywhere
        run: composer config -g preferred-install dist

      - name: Copy PHP ini
        run: cp .github/workflows/zz-php.ini /usr/local/etc/php/conf.d/

      - name: Prepare for Legacy Scenario
        if: (matrix.php_image == 'wodby/php:7.2' || matrix.php_image == 'wodby/php:5.6')
        run: |
          composer remove phpunit/phpunit --dev --no-update
          if [ "${{ matrix.php_image }}" = "wodby/php:5.6" ]; then
            composer require drupal/core-composer-scaffold:"^8.8" --no-update
          fi

      - name: Composer install (repo)
        run: |
          if [[ "${{ matrix.php_image }}" == "wodby/php:8.1" || "${{ matrix.php_image }}" == "wodby/php:8.0" ]]; then
            composer update -n --prefer-lowest
          else
            composer install -n
          fi

      - name: Scenario install (if any)
        if: ${{ matrix.install_cmd != '' }}
        env:
          COMPOSER_MEMORY_LIMIT: -1
        run: ${{ matrix.install_cmd }} || true

      - name: Remove Platform Override
        if: (matrix.php_image == 'wodby/php:7.2' || matrix.php_image == 'wodby/php:5.6')
        run: composer config --unset platform.php

      - name: Finalize dependencies
        if: ${{ matrix.install_cmd != '' }}
        env:
          COMPOSER_MEMORY_LIMIT: -1
        run: |
          # The main install has already happened, so we just ensure the lock file is honored here.
          composer install -n --prefer-dist

      - name: Install Legacy PHPUnit
        if: matrix.php_image == 'wodby/php:7.2' || matrix.php_image == 'wodby/php:5.6'
        env:
          COMPOSER_MEMORY_LIMIT: -1
        run: |
          if [ "${{ matrix.php_image }}" = "wodby/php:7.2" ]; then
            composer require phpunit/phpunit "^8.0" --dev -W
          fi
          if [ "${{ matrix.php_image }}" = "wodby/php:5.6" ]; then
            composer require phpunit/phpunit "^5.0" --dev -W
          fi

      - name: Drupal scaffold (only for php 5.6 job)
        if: ${{ matrix.scaffold == 'yes' }}
        run: composer drupal:scaffold

      - name: Install dockerize (for DB wait)
        run: |
          wget -q https://github.com/jwilder/dockerize/releases/download/${DOCKERIZE_VERSION}/dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz
          tar -C "$HOME" -xzf dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz
          rm dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz

      - name: Wait for MariaDB
        run: $HOME/dockerize -wait tcp://mariadb:3306 -timeout 60s

      - name: Set runtime env (correct paths & DSN)
        run: |
          echo "DRUSH_OPTIONS_ROOT=$GITHUB_WORKSPACE/sut/web" >> "$GITHUB_ENV"
          echo "DRUSH_OPTIONS_URI=http://default" >> "$GITHUB_ENV"
          echo "UNISH_DB_URL=mysql://root:root@mariadb:3306/testsiteaudittooldatabase" >> "$GITHUB_ENV"

      - name: Make mysql CLI avoid TLS, and precreate DB
        run: |
          cat > "$HOME/.my.cnf" <<'EOF'
          [client]
          host=mariadb
          user=root
          password=root
          protocol=tcp
          skip-ssl
          EOF
          chmod 600 "$HOME/.my.cnf"
          mysql -e 'DROP DATABASE IF EXISTS testsiteaudittooldatabase;'
          mysql -e 'CREATE DATABASE testsiteaudittooldatabase CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;'
          mysql -e 'SHOW DATABASES;'

      - name: Lint tests and check class
        run: |
          php -l tests/src/Fixtures.php
          php -r "require 'vendor/autoload.php'; var_dump(class_exists('SiteAudit\\Fixtures'));"

      - name: Provision SUT (single path) [DEBUG]
        run: |
          set -eux
          
          echo "--- Preparing site directory ---"
          SITES_DIR="${DRUSH_OPTIONS_ROOT}/sites/default"
          if [ ! -f "$SITES_DIR/settings.php" ]; then
            cp -f "$SITES_DIR"/default.settings.php "$SITES_DIR"/settings.php
            chmod 644 "$SITES_DIR"/settings.php
          fi
          
          echo "--- Running Drush site-install with maximum verbosity ---"
          # We are running drush directly again with -vvv. Since the previous fatal errors
          # are fixed, this command will now hang, and the last line of output will
          # show us the exact cause.
          vendor/drush/drush/drush si standard -y \
            --db-url="${UNISH_DB_URL}" \
            --account-name=admin \
            --account-pass=admin \
            --site-name="SUT" \
            -vvv
          
          echo "--- Site install command finished. Checking status. ---"
          vendor/drush/drush/drush status --fields=bootstrap,db-status,db-driver,db-hostname,db-name

      - name: Check SUT path
        run: |
          echo "Expecting: $GITHUB_WORKSPACE/sut/web"
          test -d "$GITHUB_WORKSPACE/sut/web" || (echo "SUT missing; did the scenario install run?" && exit 1)

      - name: Clean up test environment
        run: |
          # Remove superfluous file that causes an assertion failure.
          rm -f sut/web/test.php
          # Create a dummy module directory expected by ExtensionsTest.
          mkdir -p sut/web/modules/contrib/php

      - name: Run tests
        env:
          DRUSH_OPTIONS_ROOT: ${{ github.workspace }}/sut/web
          DRUSH_OPTIONS_URI: http://default
          UNISH_DB_URL: mysql://root:root@mariadb:3306/testsiteaudittooldatabase
        run: |
          vendor/bin/phpunit --colors=always
