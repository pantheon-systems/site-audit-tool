name: Site Audit Tool - Tests

on:
  pull_request:
  workflow_dispatch:

env:
  # Mirrors CircleCI defaults
  TZ: "/usr/share/zoneinfo/America/Los_Angeles"
  TERM: dumb
  PHPUNIT_ARGS: ""
  PHP_SENDMAIL_PATH: /dev/null
  DOCKERIZE_VERSION: v0.6.1

jobs:
  tests:
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest

    # Make UNISH_DB_URL unambiguous (job-level so it shows up in the step env)
    env:
      UNISH_DB_URL: mysql://root:@mysql/testsiteaudittooldatabase
      DRUSH_OPTIONS_URI: http://default
      DRUSH_OPTIONS_ROOT: ${{ github.workspace }}/sut/web

    # Run the job inside the desired PHP container (like Circle's primary docker image)
    container:
      image: ${{ matrix.php_image }}
      options: --user root
      env:
        MYSQL_HOST: mysql
        UNISH_DB_URL: mysql://root:@mysql/testsiteaudittooldatabase

    services:
      # MySQL service (replaces Circle's secondary docker image)
      mysql:
        image: cimg/mysql:5.7.36
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
          MYSQL_ROOT_HOST: "%"
          MYSQL_DATABASE: testsiteaudittooldatabase
        # Healthcheck so we can wait reliably
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=12
        ports:
          - 3306:3306

    strategy:
      fail-fast: false
      matrix:
        include:
          # test_81_drupal9
          - name: php 8.1 / drupal9
            php_image: wodby/php:8.1
            install_cmd: ".scenarios.lock/install drupal9"
            scaffold: "no"

          # test_80_drupal9
          - name: php 8.0 / drupal9
            php_image: wodby/php:8.0
            install_cmd: ".scenarios.lock/install drupal9"
            scaffold: "no"

          # test_73_drupal9
          - name: php 7.3 / drupal9 lowest
            php_image: wodby/php:7.3
            install_cmd: ".scenarios.lock/install drupal9 lowest"
            scaffold: "no"

          # test_73_drupal8
          - name: php 7.3 / drupal8
            php_image: wodby/php:7.3
            install_cmd: ""          # none in Circle; just composer install/test
            scaffold: "no"

          # test_72_drush8
          - name: php 7.2 / drush8
            php_image: wodby/php:7.2
            install_cmd: ".scenarios.lock/install drush8"
            scaffold: "no"

          # test_56_drupal87
          - name: php 5.6 / drupal 8.7
            php_image: wodby/php:5.6
            install_cmd: ".scenarios.lock/install php56"
            scaffold: "yes"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mark workspace as safe for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Copy PHP ini
        run: cp .github/workflows/zz-php.ini /usr/local/etc/php/conf.d/

      - name: Composer install
        run: composer install -n

      - name: Scenario install (if any)
        if: ${{ matrix.install_cmd != '' }}
        run: ${{ matrix.install_cmd }}

      - name: Drupal scaffold (only for php 5.6 job)
        if: ${{ matrix.scaffold == 'yes' }}
        run: composer drupal:scaffold

      - name: Install dockerize (for MySQL wait)
        run: |
          wget -q https://github.com/jwilder/dockerize/releases/download/${DOCKERIZE_VERSION}/dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz
          tar -C "$HOME" -xzf dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz
          rm dockerize-linux-amd64-${DOCKERIZE_VERSION}.tar.gz

      - name: Wait for MySQL
        run: $HOME/dockerize -wait tcp://mysql:3306 -timeout 1m

      - name: Disable SSL verify for mysql client
        run: |
          printf "[client]\nssl-mode=DISABLED\n" > /etc/mysql/conf.d/no-ssl.cnf || true

      - name: Show what PHP sees
        run: php -r "var_dump(getenv('UNISH_DB_URL'));"

      - name: Sanity-check DB connectivity
        run: |
          echo "UNISH_DB_URL=$UNISH_DB_URL"
          # Use MariaDB client semantics: disable TLS with --skip-ssl
          # (or call `mariadb` instead of `mysql`—they're the same binary here)
          mysql --protocol=tcp -h mysql -uroot --skip-ssl -e 'SELECT VERSION();'
          mysql --protocol=tcp -h mysql -uroot --skip-ssl -e 'SHOW DATABASES;'

      - name: Forward 127.0.0.1:3306 -> mysql:3306
        run: |
          set -eux
          # Install socat in the wodby/php image (Alpine or Debian)
          if command -v apk >/dev/null 2>&1; then
            apk add --no-cache socat
          else
            apt-get update && apt-get install -y socat
          fi
          # Forward localhost:3306 to the mysql service
          nohup socat TCP-LISTEN:3306,fork,reuseaddr TCP:mysql:3306 >/tmp/socat.log 2>&1 &
          # Optional: prove it works
          sleep 1
          mysql -h 127.0.0.1 -uroot --skip-ssl -e 'SELECT VERSION();'

      - name: Lint tests and check class
        run: |
          php -l tests/src/Fixtures.php
          php -r "require 'vendor/autoload.php'; var_dump(class_exists('SiteAudit\\Fixtures'));"

      - name: Create SUT (install Drupal once)
        run: |
          php -r "require 'vendor/autoload.php'; SiteAudit\\Fixtures::createSut(); echo \"SUT ready\n\";"
          vendor/drush/drush/drush status

      - name: Check SUT path
        run: |
          echo "Expecting: $GITHUB_WORKSPACE/sut/web"
          test -d "$GITHUB_WORKSPACE/sut/web" || (echo "SUT missing; did the scenario install run?" && exit 1)

      - name: Ensure SUT is installed
        env:
          DRUSH_OPTIONS_ROOT: ${{ github.workspace }}/sut/web
          DRUSH_OPTIONS_URI: http://default
        run: |
          set -eux
          # Is Drupal bootstrapped?
          if ! vendor/drush/drush/drush status --fields=bootstrap --format=json | grep -q '"bootstrap":"Successful"'; then
            vendor/drush/drush/drush si -y \
              --db-url="$UNISH_DB_URL" \
              --account-name=admin \
              --account-pass=admin \
              --site-name=SUT \
              standard
          fi
      
          # Show we’re really bootstrapped & DB-connected now
          vendor/drush/drush/drush status --fields=bootstrap,db-status,db-driver,db-hostname,db-name

      - name: Run tests
        run: |
          composer dump-autoload -a
          php -r "require 'vendor/autoload.php'; var_dump(method_exists('SiteAudit\\Fixtures','createSut'));"
          vendor/bin/phpunit --colors=always
          composer test
